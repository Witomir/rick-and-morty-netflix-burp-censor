var mutePoints ={
    "1": {
        "1": [
            ["00:06:09.6", 4.5],
            ["00:08:01.9", 3.9],
            ["00:09:37.5", 2.9],
            ["00:11:13.0", 3.6],
            ["00:12:30.4", 2.3],
            ["00:14:53.2", 4.0],
            ["00:14:57.4", 2.5],
            ["00:18:54.4", 3.4],
            ["00:19:17.6", 4.4],
            ["00:19:34.2", 2.8],
            ["00:20:26.2", 3.7]
        ],
        "2": [],
        "3": [
            ["00:01:23.3", 3.7],
            ["00:01:33.7", 3.4],
            ["00:03:07.4", 3.5],
            ["00:03:21.1", 2.0],
            ["00:08:46.8", 4.0],
            ["00:20:03.5", 2.7]
        ],
        "4": [
            ["00:02:57.0", 3.9],
            ["00:05:16.3", 3.1],
            ["00:08:38.6", 3.2],
            ["00:12:53.6", 3.2],
            ["00:19:08.2", 2.7]
        ],
        "5": [
            ["00:02:57.6", 3.1],
            ["00:04:17.3", 2.5],
            ["00:07:46.0", 2.1]
        ],
        "6": [
            ["00:03:32.6", 2.7]
        ],
        "7": [
            ["00:00:06.9", 3.9],
            ["00:01:09.6", 4.2],
            ["00:03:22.0", 3.5],
            ["00:07:23.1", 2.3],
            ["00:08:45.6", 3.6],
            ["00:15:21.0", 2.4],
            ["00:20:34.9", 2.1]
        ],
        "8": [
            ["00:00:59.0", 2.4],
            ["00:15:59.6", 2.9],
            ["00:16:02.5", 3.4],
            ["00:19:34.3", 4.7],
            ["00:19:43.8", 2.2],
            ["00:19:50.1", 1.8]
        ],
        "9": [
            ["00:01:53.3", 3.4],
            ["00:04:12.0", 3.5],
            ["00:05:28.5", 2.8],
            ["00:05:36.7", 3.5],
            ["00:06:52.3", 1.5],
            ["00:14:07.3", 2.4],
            ["00:16:13.2", 1.1],
            ["00:21:06.3", 4.5],
            ["00:21:13.1", 1.6]
        ],
        "10": [
            ["00:01:45.5", 3.7],
            ["00:03:20.4", 3.4],
            ["00:03:57.7", 3.6],
            ["00:06:55.3", 2.5],
            ["00:07:34.7", 4.3],
            ["00:07:45.2", 2.4],
            ["00:10:28.4", 3.0],
            ["00:14:33.4", 3.3],
            ["00:18:13.8", 3.5],
            ["00:19:16.3", 3.6],
            ["00:19:56.2", 2.8]
        ],
        "11": [
            ["00:02:17.2", 3.1],
            ["00:02:47.8", 4.2],
            ["00:08:51.3", 3.4],
            ["00:15:15.7", 1.7],
            ["00:19:45.4", 2.9],
            ["00:20:45.4", 2.7]
        ]
    },
    "2": {
        "1": [
            ["00:00:42.8", 2.7],
            ["00:06:46.7", 2.2],
            ["00:09:30.9", 3.1],
            ["00:11:54.4", 2.2],
            ["00:12:22.4", 2.1]
        ],
        "2": [
            ["00:02:43.7", 3.3]
        ],
        "3": [
            ["00:00:23.4", 2.7],
            ["00:04:01.5", 3.0],
            ["00:07:38.1", 2.0],
            ["00:14:08.6", 2.2],
            ["00:14:27.1", 1.9],
            ["00:17:46.8", 2.9],
            ["00:22:14.3", 3.0]
        ],
        "4": [
            ["00:06:09.2", 2.5]
        ],
        "5": [
            ["00:00:52.8", 4.9],
            ["00:02:57.1", 3.7],
            ["00:09:38.3", 1.7],
            ["00:09:40.1", 2.6],
            ["00:14:00.8", 2.2]
        ],
        "6": [
            ["00:00:16.1", 3.1],
            ["00:00:38.2", 3.1],
            ["00:02:25.3", 3.2],
            ["00:07:08.1", 4.6],
            ["00:08:08.9", 2.2],
            ["00:17:12.8", 2.4]
        ],
        "7": [
            ["00:06:47.5", 3.1]
        ],
        "8": [
            ["00:00:41.6", 3.2]
        ],
        "9": [
            ["00:00:12.1", 2.2],
            ["00:02:54.2", 1.3],
            ["00:04:07.5", 1.4],
            ["00:08:12.6", 1.9],
            ["00:16:09.3", 1.6],
            ["00:16:50.1", 3.5],
            ["00:18:33.2", 2.0]
        ],
        "10": [
            ["00:00:59.7", 1.5],
            ["00:07:13.1", 1.4],
            ["00:07:50.8", 2.9],
            ["00:12:24.3", 3.0]
        ]
    },
    "3": {
        "1": [
            ["00:11:27.9", 2.4],
            ["00:11:41.6", 1.9],
            ["00:13:16.0", 1.9],
            ["00:15:20.4", 4.1],
            ["00:17:51.6", 1.7],
            ["00:21:29.3", 2.9]
        ],
        "2": [
            ["00:19:34.0", 2.4]
        ],
        "3": [
            ["00:19:35.6", 1.7]
        ],
        "4": [
            ["00:04:48.2", 3.9],
            ["00:08:12.5", 2.4],
            ["00:10:04.4", 2.0],
            ["00:10:28.2", 2.2],
            ["00:10:45.9", 3.4],
            ["00:12:02.4", 4.8],
            ["00:13:14.5", 1.6],
            ["00:19:14.9", 2.8]
        ],
        "5": [
            ["00:00:36.5", 2.1]
        ],
        "6": [
            ["00:00:42.3", 1.9],
            ["00:04:38.3", 2.1],
            ["00:04:40.5", 1.7],
            ["00:14:13.1", 2.0],
            ["00:16:04.0", 1.9],
            ["00:16:06.0", 2.4],
            ["00:20:27.1", 2.0]
        ],
        "7": [
            ["00:00:25.6", 3.3],
            ["00:00:43.7", 2.0],
            ["00:06:09.2", 1.7],
            ["00:17:15.3", 1.6],
            ["00:19:01.0", 1.9]
        ],
        "8": [
            ["00:01:43.3", 2.3],
            ["00:01:45.7", 2.7]
        ],
        "9": [
            ["00:10:14.8", 2.3]
        ],
        "10": [
            ["00:09:05.8", 1.4],
            ["00:21:10.6", 1.8]
        ]
    }
};

var videoElement;
var appIntervalId;
var currentSeason;
var currentEpisode;

chrome.runtime.onMessage.addListener(data => {
    //if(request.scriptOptions && request.scriptOptions.imageUrl){}
    if (data.action == "watching") {
        console.log("page URL changed, reloading app");
        restartApp();
    }
});

if(window.location.pathname.startsWith('/watch')){
    sheduleNextVideoLookup();
}

function restartApp() {
    disableApp();
    startLookingForVideoElement();
}

function runApp (video, episodeNumber) {
    console.log(episodeNumber);
    currentSeason = getSeasonNumberFromVideoTitle(episodeNumber);
    currentEpisode = getEpisodeNumberFromVideoTitle(episodeNumber);
    appIntervalId = setInterval(checkTimeLoop, 100);
    addTimestamperButtons(currentSeason, currentEpisode);
};

function startLookingForVideoElement () {
    var video = document.getElementsByTagName("video");
    var episodeNumber = document.querySelector('.video-title span');
    var title = document.querySelector('.video-title h4');
    if (video.length > 0 && episodeNumber != null && title.innerText == "Rick and Morty") {
        videoElement = video[0];
        runApp(videoElement, episodeNumber.innerText);
    } else {
        sheduleNextVideoLookup();
    }
};

function sheduleNextVideoLookup(){
    setTimeout(startLookingForVideoElement, 100);
}

function checkTimeLoop(){
    if(videoElement){
        var currentVideoTime = videoElement.currentTime;
        currentVideoTime = Math.round(currentVideoTime * 10);
        if(mutePoints[currentSeason] && mutePoints[currentSeason][currentEpisode]){
            var curentEpisodeMuteData = mutePoints[currentSeason][currentEpisode];
            for(var i = 0; i < curentEpisodeMuteData.length; i++){
                var currentPoint = curentEpisodeMuteData[i];
                var muteTimestamp = timeToTimestamp(currentPoint[0]) * 10;
                var muteDuration = currentPoint[1] * 1000;

                if(currentVideoTime == muteTimestamp) {
                    muteVideo();
                    unmuteVideoAfter(muteDuration);
                }
            }
        }
    }
}

function disableApp() {
    clearInterval(appIntervalId);
};

function muteVideo() {
    videoElement.muted = true;
    console.log("mute!");
}

function unmuteVideoAfter(bleepDuration) {
    setTimeout(function(){
        videoElement.muted = false;
        console.log("unmuted");
    }, bleepDuration);
}

function getSeasonNumberFromVideoTitle(videoTitle) {
    return parseInt(videoTitle.substr(1,1));
};

function getEpisodeNumberFromVideoTitle(videoTitle) {
    return parseInt(videoTitle.substr(4,6));
};

var timeToTimestamp = function (customTimestamp) {
    var hours = parseInt(customTimestamp.substr(0,2));
    var minutes = parseInt(customTimestamp.substr(3,2));
    var seconds = parseInt(customTimestamp.substr(6,4));

    return seconds + 60*minutes + 60*60*hours;
};

function addLeadingZero(number){
    return number < 10 ? "0" + number : number;
}

var timestampToTime = function (timestamp) {
    var centiseconds = parseInt((timestamp - parseInt(timestamp)) * 10);
    var date = new Date(timestamp * 1000);
    var hh = addLeadingZero(date.getUTCHours());
    var mm = addLeadingZero(date.getUTCMinutes());
    var ss = addLeadingZero(date.getSeconds());
    return hh + ":" + mm + ":" + ss + "." + centiseconds;
};

var addFakeArray = function (time) {
    return `["${time}", 1.0],`;
};

var addTimestamperButtons = function (currentSeason, currentEpisode) {
    var rootElement = document.querySelector('.PlayerControls--button-control-row');
    var addTimeArea = document.createElement('div');
    addTimeArea.setAttribute('class', 'touchable PlayerControls--control-element nfp-popup-control');

    var addButton = document.createElement('button');
    addButton.innerHTML = "Add burp"
    addButton.setAttribute('style', 'color:black; width:50px');
    addButton.setAttribute('class', 'custom-js-button');
    addButton.addEventListener('click', () => {
        var textarea = document.getElementById('mute-data-content');
        var timestamp = videoElement.currentTime;
        var timeWord = addFakeArray(timestampToTime(timestamp));
        textarea.value += timeWord + "\n";
    });



    var showDataButton = document.createElement('button');
    showDataButton.innerHTML = "Show burps"
    showDataButton.setAttribute('class', 'custom-js-button');
    showDataButton.setAttribute('style', 'color:black; width:50px');
    showDataButton.addEventListener('click', function showModal() {
        modal.style.display = "block";
    });

    addTimeArea.appendChild(addButton);
    addTimeArea.appendChild(showDataButton);
    rootElement.appendChild(addTimeArea);

    var modalContent = `
    <div id="myModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <span class="close">&times;</span>
            <h2>Burp timestamps</h2>
          </div>
          <div class="modal-body">
            <textarea cols="100" rows="20" id="mute-data-content"></textarea>
          </div>
          <div class="modal-footer">
            <h3></h3>
          </div>
        </div>
    </div>`;

    var modalElement = document.createElement('div');
    modalElement.innerHTML = modalContent;
    document.body.appendChild(modalElement);

    var modal = document.getElementById('myModal');
    var span = document.getElementsByClassName("close")[0];
    span.onclick = function() {
        modal.style.display = "none";
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
    var textarea = document.getElementById('mute-data-content');
    textarea.value += `S${currentSeason}E${currentEpisode}:\n`;
};
